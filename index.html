<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TKU 午夜任務｜規則怪談×校園鬼故事</title>
  <meta name="description" content="TKU校園規則怪談×都市傳說｜18題RPG心理測驗｜手機單手友善｜最後揭曉最適合的畢業專題類型" />
  <style>
    :root{
      --bg:#070a14;
      --card:#0e1530;
      --text:#eef1ff;
      --muted:#b2b9e6;
      --line:rgba(255,255,255,.12);
      --accent:#90d2ff;
      --accent2:#b7ffcc;
      --danger:#ff8c8c;
      --shadow:0 18px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC","PingFang TC","Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(144,210,255,.18), transparent 55%),
        radial-gradient(900px 650px at 85% 10%, rgba(183,255,204,.12), transparent 55%),
        radial-gradient(900px 900px at 50% 100%, rgba(160,140,255,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow:hidden; /* 手機不捲動 */
    }
    .app{
      height:100dvh;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom);
      display:flex;
      flex-direction:column;
      gap:12px;
      max-width: 860px;
      margin:0 auto;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      padding: 10px 4px 0;
    }
    .h1{
      font-size: clamp(18px, 4.2vw, 26px);
      font-weight: 1000;
      letter-spacing:.4px;
      line-height:1.1;
    }
    .h2{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:6px;
      max-width: 54ch;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:7px 10px;
      border-radius:999px;
      user-select:none;
    }
    .card{
      flex:1;
      display:flex;
      flex-direction:column;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .where{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .where .k{
      font-size:11px;
      color:var(--accent);
      font-weight:900;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .where .t{
      font-size:14px;
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .prog{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      min-width: 140px;
    }
    .prog .count{
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .bar{
      width: 160px;
      max-width: 38vw;
      height: 9px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar>div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(144,210,255,.95), rgba(183,255,204,.95));
      transition: width .25s ease;
    }
    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      padding: 12px;
      gap:10px;
      background:
        radial-gradient(500px 260px at 30% 0%, rgba(144,210,255,.08), transparent 55%),
        radial-gradient(600px 300px at 70% 0%, rgba(183,255,204,.06), transparent 60%),
        rgba(0,0,0,.06);
    }
    .story{
      flex:1;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding: 12px;
      overflow:hidden; /* 不捲動 */
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .p{
      font-size: 15px;
      line-height: 1.55;
      margin:0;
      color: var(--text);
      white-space:pre-wrap;
    }
    .p.muted{ color: var(--muted); font-size: 13px; line-height: 1.45;}
    .p.small{ font-size: 13px; color: var(--muted); }
    .divider{ height:1px; background: var(--line); margin: 2px 0; }
    .question{
      font-size: 16px;
      font-weight: 1000;
      line-height: 1.35;
      margin:0;
    }
    .choices{ display:grid; gap:10px; }
    .btn{
      width:100%;
      border-radius: 16px;
      padding: 12px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-align:left;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:flex-start;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn:hover{ background: rgba(144,210,255,.10); border-color: rgba(144,210,255,.40); }
    .tag{
      width: 30px; height: 30px;
      border-radius: 12px;
      display:grid; place-items:center;
      font-weight: 1000;
      flex: 0 0 auto;
      background: rgba(144,210,255,.14);
      border: 1px solid rgba(144,210,255,.25);
      color: var(--accent);
    }
    .txt{ line-height:1.4; font-size: 14px; }

    .foot{
      padding: 10px 12px 12px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .mini{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mbtn{
      border-radius: 12px;
      padding: 9px 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight:900;
      font-size: 12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .mbtn.primary{ background: rgba(144,210,255,.14); border-color: rgba(144,210,255,.40); }
    .mbtn.danger{ background: rgba(255,140,140,.12); border-color: rgba(255,140,140,.35); }
    .mtext{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.3;
      text-align:right;
      max-width: 50vw;
    }

    .result{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding: 12px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 11px;
      width: fit-content;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: rgba(144,210,255,.95);
      box-shadow: 0 0 0 4px rgba(144,210,255,.14);
    }
    .rtitle{ font-size: 18px; font-weight: 1100; margin:0; }
    .rbody{ font-size: 14px; line-height: 1.6; color: var(--text); margin:0; white-space:pre-wrap; }
    .scores{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .sitem{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 9px 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .sitem strong{ color: var(--text); font-size: 12px; }

    /* 氣氛：漂浮光點 */
    .ghost{
      position:absolute;
      inset:auto 12px 150px auto;
      width:10px; height:10px;
      border-radius:50%;
      background: rgba(183,255,204,.65);
      box-shadow: 0 0 24px rgba(183,255,204,.35);
      animation: float 3.6s ease-in-out infinite;
      opacity:.55;
      pointer-events:none;
    }
    @keyframes float{
      0%,100%{ transform: translate(0,0); }
      50%{ transform: translate(-6px, -10px); }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <div class="h1">TKU 午夜任務</div>
        <div class="h2">規則怪談×校園鬼故事｜最後揭曉最適合的畢業專題類型</div>
      </div>
    </header>

    <section class="card" aria-live="polite">
      <div class="topbar">
        <div class="where">
          <div class="k" id="kicker">序章</div>
          <div class="t" id="place">校門口的霧</div>
        </div>
        <div class="prog">
          <div class="count" id="counter">0 / 18</div>
          <div class="bar"><div id="barFill"></div></div>
        </div>
      </div>

      <div class="content">
        <div class="ghost" aria-hidden="true"></div>

        <div class="story">
          <p class="p" id="storyText"></p>
          <div class="divider"></div>
          <p class="question" id="questionText"></p>
          <p class="p muted" id="hintText"></p>
        </div>

        <div class="choices" id="choices"></div>
      </div>

      <div class="foot">
        <div class="mini">
          <button class="mbtn primary" id="startBtn">開始</button>
          <button class="mbtn" id="backBtn" disabled>返回</button>
          <button class="mbtn danger" id="restartBtn" disabled>重來</button>
        </div>
        <div class="mtext" id="microText">提示：選你最像的反應，不用想「正確答案」。</div>
      </div>
    </section>
  </div>

<script>
  // 7類結果：論文/戲劇/創作/筆譯/口譯/雜誌編輯/觀光導覽
  // 內部代碼：R(Research) T(Theatre) C(Creation) WT(Written Translation) IT(Interpreting) E(Edit) G(Guide)
  const TYPES = ["R","T","C","WT","IT","E","G"];
  const STEPS = 18;

  function initScores(){ const s={}; TYPES.forEach(k=>s[k]=0); return s; }
  function cloneScores(s){ const o={}; TYPES.forEach(k=>o[k]=s[k]); return o; }
  function applyScore(scoreObj){ if(!scoreObj) return; for(const k of Object.keys(scoreObj)) state.scores[k]+=scoreObj[k]; }
  function escapeHtml(str){ return (str??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

  function typeName(k){
    return ({
      R:"論文型",
      T:"戲劇型",
      C:"創作型",
      WT:"筆譯型",
      IT:"口譯型",
      E:"雜誌編輯型",
      G:"觀光導覽型"
    })[k]||k;
  }

  const RESULTS = {
    R:{
      badge:"你會先問：規則怎麼證明？線索在哪？",
      title:"【結果】最適合：學術論文",
      body:
`你在恐怖場景裡最像「冷靜拆解派」：會先確認、先定位、先整理出可驗證的規則。\n\n你適合做「學術論文」類型的畢業專題。\n你強項：聚焦題目、找文獻、做框架、把模糊變清楚。\n你需要：固定進度節奏、資料管理、不要拖到最後爆炸。`
    },
    T:{
      badge:"你會把緊張轉成『演得過去』的節奏。",
      title:"【結果】最適合：戲劇公演",
      body:
`你遇到怪事不一定最理性，但你很會「用表現」把場面撐住：大喊、帶氣氛、用幽默或氣勢壓回去。\n\n你適合做「戲劇公演」類型的畢業專題。\n你強項：節奏感、臨場、團隊溝通、排練耐性。\n你需要：分工明確、準時、把細節磨到位。`
    },
    C:{
      badge:"你腦中會立刻浮出：這可以改成作品。",
      title:"【結果】最適合：創作",
      body:
`你最像「靈感改寫派」：越毛越有畫面，越怪越想把它收束成一個好看的結局。\n\n你適合做「創作」類型的畢業專題（文章/影片/企劃/作品等）。\n你強項：世界觀、橋段、畫面感、快速產出雛形。\n你需要：不要只想，要做；先做出版本，再迭代。`
    },
    WT:{
      badge:"你對字句跟規則很敏感：不清楚就不安心。",
      title:"【結果】最適合：翻譯（筆譯）",
      body:
`你最像「細節潔癖派」：會記規則、會抓措辭、會在意一致性與上下文。\n\n你適合做「翻譯（筆譯）」類型的畢業專題。\n你強項：用詞一致、譯注、版本管理、反覆潤稿。\n你需要：耐心與時間、固定校對流程、別跟自己過不去。`
    },
    IT:{
      badge:"你會先讓事情『順利往前走』，然後再補細節。",
      title:"【結果】最適合：翻譯（口譯）",
      body:
`你最像「降溫救場派」：敢說、敢問、敢把場面救回來；越緊張越能講清楚。\n\n你適合做「翻譯（口譯）」類型的畢業專題。\n你強項：臨場反應、抓重點、表達清楚、壓力管理。\n你需要：大量情境練習、錄音回聽、固定筆記系統。`
    },
    E:{
      badge:"你腦中自帶『整理成可讀版本』的編排感。",
      title:"【結果】最適合：雜誌編輯",
      body:
`你最像「把混亂排成順序的人」：會蒐證、會整理、會想讀者看不看得懂。\n\n你適合做「雜誌編輯」類型的畢業專題。\n你強項：主題策劃、排版流程、校對、死線管理。\n你需要：清楚的稿件流程與分工、不要一次想做太大。`
    },
    G:{
      badge:"你下意識會先帶路、先讓大家安心。",
      title:"【結果】最適合：觀光導覽",
      body:
`你最像「帶隊領航派」：遇到怪事第一反應是找人、找亮的地方、找出口、讓隊伍不要散。\n\n你適合做「觀光導覽」類型的畢業專題。\n你強項：導覽節奏、互動設計、臨場應變、說故事能力。\n你需要：腳本、路線規劃、備案，還有膽量面對突發狀況。`
    }
  };

  const NODES = {
    q0:{
      place:"校門口的霧",
      story:
`你站在淡江校門口。\n霧很重，像有人把校園「包起來」了。\n手機跳出一則未讀訊息（沒有來電顯示）：\n「今晚完成『午夜任務』，你就會知道自己適合走哪條路。\n不要把任務說出口。\n如果你想放棄——你會發現門打不開。」\n\n你第一個反應是？`,
      question:"你會怎麼開始？",
      hint:"（選你最像的反應，不用想正確答案。）",
      choices:[
        {label:"先確認：我先看時間、電量、身上有沒有行動電源。", next:"q1", score:{R:1,WT:1}},
        {label:"先找人：我傳訊息問朋友有沒有人還在學校/宿舍。", next:"q1", score:{G:1,IT:1}},
        {label:"先拍一下：這霧太像傳說場景了，我想留個證據。", next:"q1", score:{E:1,C:1}},
        {label:"先裝沒事：我就當自己只是走夜路，別想太多。", next:"q1", score:{T:1,G:1}},
      ]
    },

    q1:{
      place:"海報牆",
      story:
`你走過海報牆。\n昏黃燈下，有一張很舊的活動海報突然自己鬆開，滑到你腳邊。\n海報上寫著：\n「不要在海報前念出年份。」\n\n但海報日期偏偏印得超大，像故意要你看。`,
      question:"你會怎麼處理？",
      hint:"這裡開始有第一條規則味道，但還不確定真假。",
      choices:[
        {label:"把年份遮住：我用手蓋住再看內容，避免自己順口念出來。", next:"q2", score:{WT:1,R:1}},
        {label:"拍照留存：我不念出來，但我想記下海報長什麼樣。", next:"q2", score:{E:1,C:1}},
        {label:"覺得毛：我直接踢開海報，不碰它，快走。", next:"q2", score:{G:1}},
        {label:"反其道而行：我小聲念出年份，想測規則真假。", next:"q2", score:{C:1,T:1}},
      ]
    },

    q2:{
      place:"宮燈大道（第三盞）",
      story:
`你踏上宮燈大道。\n走到第三盞宮燈下，燈光突然跳了一下。\n身後傳來一個很溫柔、很有禮貌的女聲：\n「同學，不好意思…可以請你告訴我現在幾點嗎？」\n\n你正要轉身，燈罩裡又冒出另一個聲音——像廣播，沒有情緒：\n「提示：請勿主動說出現在時間。」\n\n同一個人，兩種聲音。`,
      question:"你怎麼反應最像你？",
      hint:"",
      choices:[
        {label:"不回頭、不回答：我加快走，當沒聽到。", next:"q3", score:{WT:1,R:1}},
        {label:"回答但不報時間：『抱歉我趕時間…』然後走。", next:"q3", score:{IT:1,G:1}},
        {label:"回頭直視：我想看清楚她到底是誰。", next:"q3", score:{T:1,C:1}},
        {label:"我先反問：『你是誰？你為什麼問？』", next:"q3", score:{IT:1,T:1}},
      ]
    },

    q3:{
      place:"黑天鵝附近",
      story:
`你離開第三盞沒多久，附近突然「啪」一聲。\n有黑影掠過你頭頂，像鳥，但大得不合理。\n你沒被打到，可是背脊瞬間起雞皮疙瘩。\n\n你會怎麼做？`,
      question:"第一反應？",
      hint:"這題很現實：你是躲？吼？觀察？還是用怪招？",
      choices:[
        {label:"先閃避：蹲下/護頭/立刻拉開距離。", next:"q4", score:{G:1,IT:1}},
        {label:"用氣勢：我大吼一聲＋揮手趕走。", next:"q4", score:{T:1}},
        {label:"先觀察：我停一下看它到底攻擊誰、從哪來。", next:"q4", score:{R:1}},
        {label:"用誘餌/道具：我丟水瓶/麵包吸引它，趁機走。", next:"q4", score:{C:1,E:1}},
      ]
    },

    q4:{
      place:"外語大樓走廊",
      story:
`你進入外語大樓。\n走廊只亮一半，另一半是暗的。\n前方有清潔阿姨在拖地，但她一直拖同一塊地，像卡住。\n\n你靠近時，她用很小聲的溫柔語氣說：\n「同學…不要走到『黑的那邊』。」\n下一秒，她聲音又變成廣播式：\n「提示：請勿與清潔人員確認身份。」`,
      question:"你怎麼處理最像你？",
      hint:"你會打招呼嗎？還是完全不碰？",
      choices:[
        {label:"不打招呼：我貼牆走、放輕腳步，快速通過。", next:"q5", score:{WT:1}},
        {label:"禮貌一句就走：『阿姨辛苦了』，不問任何事。", next:"q5", score:{G:1,IT:1}},
        {label:"想幫忙：我問『需要幫忙嗎？』但保持距離。", next:"q5", score:{G:1}},
        {label:"我會記下規則：不問身份這點很怪，我想留做線索。", next:"q5", score:{R:1,E:1}},
      ]
    },

    q5:{
      place:"文化教室的半開門",
      story:
`你經過一間半開門的文化教室。\n裡面有人在上課，聽得出是「日文」。\n但時間是凌晨。\n你從門縫看到：學生背影全都坐得很端正，一點小動作都沒有，反而很不真實。\n\n你會？`,
      question:"你怎麼做？",
      hint:"這題要選你真的會做的事。",
      choices:[
        {label:"先觀察5秒：我想確定是不是有人惡作劇或拍片。", next:"q6", score:{R:1,WT:1}},
        {label:"我直接離開：不該看的不看，先走。", next:"q6", score:{G:1}},
        {label:"敲門問一句：『請問現在是什麼課？』", next:"q6", score:{IT:1,T:1}},
        {label:"偷偷錄個3秒：不解釋、不曝光，純粹留證據。", next:"q6", score:{E:1}},
      ]
    },

    q6:{
      place:"商管大樓電梯",
      story:
`你進商管大樓想去5樓。\n電梯門開到一個「沒有樓層顯示」的黑走廊。\n你直覺：這不是正常樓層。\n\n你會怎麼辦？`,
      question:"你下一步？",
      hint:"很現實：你敢不敢踏出去？",
      choices:[
        {label:"絕不出去：猛按關門＋按回一樓。", next:"q7", score:{WT:1,G:1}},
        {label:"踏出一步看一下：我只出去一步，隨時縮回來。", next:"q7", score:{C:1,T:1}},
        {label:"先拍顯示/錄面板：我想記住這個異常點。", next:"q7", score:{E:1,R:1}},
        {label:"大聲問：『有人嗎？』我想確認是不是有人受困。", next:"q7", score:{G:1,IT:1}},
      ]
    },

    q7:{
      place:"D棟電梯口",
      story:
`你到D棟。\n電梯自己「叮」一聲開了。\n裡面沒人。\n但你聽到很壓抑的哭聲，像是從電梯井深處傳來。\n\n此刻你腦袋裡只剩一句：不要多管閒事？還是要幫？`,
      question:"你會怎麼做？",
      hint:"選你最像的。",
      choices:[
        {label:"避開電梯：我走樓梯，離它遠一點。", next:"q8", score:{WT:1,G:1}},
        {label:"靠近看一下：我想確認裡面到底有沒有什麼。", next:"q8", score:{R:1}},
        {label:"鞠躬道歉：『打擾了』，然後離開。", next:"q8", score:{G:1}},
        {label:"出聲安撫：『你需要幫忙嗎？我可以帶你出去。』", next:"q8", score:{IT:1,G:1}},
      ]
    },

    q8:{
      place:"廁所鏡子",
      story:
`你不得不去廁所。\n洗手台鏡子裡，你看見最後一間隔間下面有一雙腳。\n你很確定：你進來時這裡是空的。\n隔間門慢慢開了一條縫。\n\n你會？`,
      question:"你怎麼做？",
      hint:"這題不要當英雄，選你真的會做的。",
      choices:[
        {label:"裝沒看到：立刻走出廁所，不逗留。", next:"q9", score:{G:1}},
        {label:"拿東西當武器：拖把/垃圾桶，壯膽吼一句。", next:"q9", score:{T:1}},
        {label:"不看鏡子：低頭、離開，避免再對上畫面。", next:"q9", score:{WT:1,R:1}},
        {label:"用半開玩笑壓住恐懼：小聲念幾句保佑，快走。", next:"q9", score:{C:1,IT:1}},
      ]
    },

    q9:{
      place:"整層停電",
      story:
`你剛離開廁所，整層燈瞬間全滅。\n你手機亮起低電量警告。\n黑暗裡你聽到一句很小的廣播音：\n「提示：不要在黑暗中說『我沒事』。」\n\n你會？`,
      question:"你怎麼應對停電？",
      hint:"你是省電派？還是求援派？",
      choices:[
        {label:"開手電筒＋找出口標示：先把路線弄清楚。", next:"q10", score:{R:1,G:1}},
        {label:"原地等30秒：我想確認是不是跳電，別亂跑。", next:"q10", score:{WT:1,R:1}},
        {label:"直接走：靠記憶摸到樓梯間再說。", next:"q10", score:{IT:1}},
        {label:"關掉手電筒省電：我寧可慢一點，也要留電。", next:"q10", score:{WT:1}},
      ]
    },

    q10:{
      place:"電量 10%",
      story:
`你手機剩10%。\n你突然想到：如果前面你有「拍照/錄影」，現在更危險。\n因為低電量＝你連照明跟求助都可能沒了。\n\n你會做哪個最像你？`,
      question:"你怎麼處理電量？",
      hint:"這題很真實。",
      choices:[
        {label:"極限省電：關背景、調暗、只在必要時亮。", next:"q11", score:{WT:1,R:1}},
        {label:"找插座：我寧可繞路也要先充一下。", next:"q11", score:{E:1,R:1}},
        {label:"先報備：傳訊息/打給朋友說我在哪、在幹嘛（不提任務）。", next:"q11", score:{G:1,IT:1}},
        {label:"關機硬走：我相信自己記得路，省電到最後。", next:"q11", score:{T:1,G:1}},
      ]
    },

    q11:{
      place:"鬼來電",
      story:
`你手機響了。\n來電顯示：『外語大樓』\n你想起早先的提示：不要確認身份；不要說我沒事；不要把任務說出口。\n\n你會怎麼接？`,
      question:"你怎麼處理來電？",
      hint:"這題選真實反應。",
      choices:[
        {label:"接起來：我說『喂？』但不透露我在做什麼。", next:"q12", score:{IT:1,T:1}},
        {label:"不接：讓它響完，我專注走路。", next:"q12", score:{R:1}},
        {label:"接通不出聲：我先聽對方講什麼。", next:"q12", score:{WT:1,R:1}},
        {label:"直接掛斷＋開飛航：我不想被它帶節奏。", next:"q12", score:{E:1,G:1}},
      ]
    },

    q12:{
      place:"身後腳步聲",
      story:
`你走出D棟外面，路燈還亮。\n你聽到身後也有腳步聲。\n你走快，它也走快；你停，它也停。\n\n你背脊發麻：跟著你的到底是人還是別的？`,
      question:"你會怎麼做？",
      hint:"現實反應題。",
      choices:[
        {label:"不回頭：直接往人多處走。", next:"q13", score:{G:1,R:1}},
        {label:"突然回頭吼：『誰？不要跟！』", next:"q13", score:{T:1}},
        {label:"拿鑰匙防身：保持走路，但準備自保。", next:"q13", score:{WT:1}},
        {label:"拐進亮的販賣機區：裝買飲料，順便用燈看身後。", next:"q13", score:{E:1,IT:1}},
      ]
    },

    q13:{
      place:"陌生學妹求助",
      story:
`黑天鵝附近，一個學妹樣子的女生站在路中央。\n她聲音發抖：\n「學長/學姊…可以陪我去找東西嗎？我不敢一個人…」\n\n她看起來很可憐，但也很不對勁。\n你會？`,
      question:"你會怎麼回應？",
      hint:"你是會幫？會驗證？會拒絕？",
      choices:[
        {label:"答應陪她：一起走比較不孤單。", next:"q14", score:{G:2}},
        {label:"先問細節：你哪一系？丟什麼？在哪丟？", next:"q14", score:{R:1,IT:1}},
        {label:"婉拒＋建議找校安：我不敢陪走夜路。", next:"q14", score:{WT:1,G:1}},
        {label:"保持距離繞開：我直覺這不是正常情況。", next:"q14", score:{WT:1,R:1}},
      ]
    },

    q14:{
      place:"校門上鎖",
      story:
`你走到校門口想離開。\n門真的打不開。\n鐵鎖冰冷。\n你想起一開始那句：\n「如果你想放棄——你會發現門打不開。」\n\n規則開始成形了：它真的會『回收』你前面的選擇。`,
      question:"你現在會怎麼做？",
      hint:"很現實：崩潰？求援？堅持？翻牆？",
      choices:[
        {label:"咬牙回頭：好，我把任務走完。", next:"q15", score:{R:1,WT:1}},
        {label:"大喊求救：我想把警衛或外面的人叫醒。", next:"q15", score:{T:1,IT:1}},
        {label:"先休息冷靜：找亮處坐一下再決定。", next:"q15", score:{E:1,R:1}},
        {label:"想翻牆：我不想被規則綁架。", next:"q15", score:{C:1,G:1}},
      ]
    },

    q15:{
      place:"鐘聲（不該有）",
      story:
`凌晨的校園突然傳來很遠的鐘聲。\n你知道這裡平常不會有這種整點鐘。\n鐘聲像在引路。\n\n同時你手機又跳出一行字（像系統通知）：\n「提示：如果你一直在拍照，請停止。你不需要更多證據。」`,
      question:"你會怎麼面對鐘聲？",
      hint:"你會跟著走？還是守自己的路？",
      choices:[
        {label:"跟著鐘聲走：我相信它在引我去終點。", next:"q16", score:{G:1,C:1}},
        {label:"不理：按原計畫走，避免被帶節奏。", next:"q16", score:{WT:1,R:1}},
        {label:"當警告：我去找保全/亮處，先確保安全。", next:"q16", score:{G:1,R:1}},
        {label:"停下祈禱一下：不是迷信，是讓自己穩住。", next:"q16", score:{IT:1,E:1}},
      ]
    },

    q16:{
      place:"蛋捲廣場的身影",
      story:
`你到一個開闊的廣場。\n遠處有一道站著不動的人影。\n像老式制服的背影。\n你靠近一點，那影子沒有回頭。\n\n你突然想起一條你一路收集到的「隱性規則」：\n『不要主動確認對方身份。』`,
      question:"你會怎麼做？",
      hint:"你會尊重、溝通、觀察、或蒐證？",
      choices:[
        {label:"鞠躬致意：不問身份，只說『打擾了』。", next:"q17", score:{G:1,WT:1}},
        {label:"嘗試對話：『你需要幫忙嗎？』但不問你是誰。", next:"q17", score:{IT:1,G:1}},
        {label:"保持距離觀察：我想看它要幹嘛。", next:"q17", score:{R:1}},
        {label:"偷拍一張：我想留下最後證據（但不開閃光）。", next:"q17", score:{E:1}},
      ]
    },

    q17:{
      place:"好友出現",
      story:
`你身後突然有人叫你名字。\n你回頭看到「朋友」跑來：\n「你在這裡喔！我找你很久。你沒事吧？」\n\n你瞬間安心又警覺。\n因為規則也說過：不要說任務。\n而且你也不確定——他真的是他嗎？`,
      question:"你會怎麼回？（最後一題）",
      hint:"你會守密？驗證？還是直接傾吐？",
      choices:[
        {label:"反問細節試探：你怎麼知道我在這？你剛剛在哪？", next:"end", score:{R:2}},
        {label:"守口如瓶：『我沒事，走吧』不解釋任何事。", next:"end", score:{WT:2}},
        {label:"直接把整晚講出來：我真的憋不住，我需要有人聽。", next:"end", score:{IT:2,T:1}},
        {label:"用只有你們懂的暗號驗證：先確定他是本人再說。", next:"end", score:{E:1,R:1}},
      ]
    },

    end:{
      place:"破曉",
      story:
`天開始亮了。\n霧慢慢散開。\n你突然理解：這一晚不是要你找「唯一正解」；而是看你在壓力下，最自然會怎麼做。\n\n最後一條通知跳出來：\n「你不需要完美，你只需要走你最像的那條路。」`,
      question:"", hint:"", choices:[]
    }
  };

  let state = {
    started:false,
    nodeId:"q0",
    step:0,
    history:[],
    scores:initScores(),
    lastTiebreak:null
  };

  function computeWinner(){
    const max = Math.max(...TYPES.map(k=>state.scores[k]));
    const winners = TYPES.filter(k=>state.scores[k]===max);
    if(winners.length===1) return winners[0];
    // 平手處理：優先看更「定向」的類型（你也可自行調整）
    const priority = ["R","WT","IT","E","G","C","T"];
    for(const p of priority) if(winners.includes(p)) return p;
    return winners[0];
  }

  function setText(id, t){ document.getElementById(id).textContent = t; }

  function setProgress(){
    const pct = state.started ? (Math.min(state.step, STEPS)/STEPS)*100 : 0;
    document.getElementById("barFill").style.width = `${pct}%`;
    setText("counter", `${state.started ? Math.min(state.step, STEPS):0} / ${STEPS}`);
  }

  function nodeIsEnd(){ return state.nodeId==="end"; }

  function render(){
    const node = NODES[state.nodeId];

    setText("kicker", state.started ? "午夜任務" : "序章");
    setText("place", node.place);
    setText("storyText", node.story);
    setText("questionText", node.question || "");
    setText("hintText", node.hint || "");

    document.getElementById("startBtn").disabled = state.started;
    document.getElementById("restartBtn").disabled = !state.started;
    document.getElementById("backBtn").disabled = state.history.length===0;

    const micro = document.getElementById("microText");
    micro.textContent = nodeIsEnd()
      ? "你可以重來走不同反應路線（結果會變）。"
      : "提示：選你最像的反應，不用想「正確答案」。";

    const choicesEl = document.getElementById("choices");
    choicesEl.innerHTML = "";

    if(nodeIsEnd()){
      const winner = computeWinner();
      const r = RESULTS[winner];

      const wrap = document.createElement("div");
      wrap.className = "result";
      wrap.innerHTML = `
        <div class="badge"><span class="dot"></span><span>${escapeHtml(r.badge)}</span></div>
        <h3 class="rtitle">${escapeHtml(r.title)}</h3>
        <p class="rbody">${escapeHtml(r.body)}</p>
        <div class="divider"></div>
        <p class="p small">（分數概覽）</p>
        <div class="scores" id="scoreGrid"></div>
        <div style="display:flex; gap:10px; margin-top:6px;">
          <button class="mbtn primary" id="shareBtn" style="flex:1;">複製結果連結</button>
          <button class="mbtn" id="copyTextBtn" style="flex:1;">複製結果文字</button>
        </div>
      `;
      choicesEl.appendChild(wrap);

      const pairs = TYPES.map(k=>({k,v:state.scores[k]})).sort((a,b)=>b.v-a.v);
      const grid = wrap.querySelector("#scoreGrid");
      pairs.forEach(p=>{
        const d=document.createElement("div");
        d.className="sitem";
        d.innerHTML = `<strong>${escapeHtml(typeName(p.k))}</strong><span>${p.v}</span>`;
        grid.appendChild(d);
      });

      wrap.querySelector("#shareBtn").onclick = () => shareResult(winner);
      wrap.querySelector("#copyTextBtn").onclick = () => copyResultText(winner);

      const url = new URL(location.href);
      url.searchParams.set("result", winner);
      history.replaceState(null, "", url.toString());
      return;
    }

    node.choices.forEach((c, i)=>{
      const btn=document.createElement("button");
      btn.className="btn";
      btn.type="button";
      const key=["A","B","C","D"][i] || String(i+1);
      btn.innerHTML = `<div class="tag">${key}</div><div class="txt">${escapeHtml(c.label)}</div>`;
      btn.onclick = ()=>pick(c);
      choicesEl.appendChild(btn);
    });
  }

  function pick(choice){
    if(!state.started){
    state.started = true;
    document.getElementById("startBtn").disabled = true;
    document.getElementById("restartBtn").disabled = false;
  }
    state.history.push({
      nodeId: state.nodeId,
      step: state.step,
      scores: cloneScores(state.scores)
    });

    applyScore(choice.score);

    state.nodeId = choice.next;
    state.step = Math.min(state.step + 1, STEPS);

    const url = new URL(location.href);
    url.searchParams.delete("result");
    history.replaceState(null, "", url.toString());

    setProgress();
    render();
  }

  function start(){
    state.started=true;
    state.nodeId="q0";
    state.step=0;
    state.history=[];
    state.scores=initScores();

    const url=new URL(location.href);
    url.searchParams.delete("result");
    history.replaceState(null,"",url.toString());

    setProgress();
    render();
  }

  function back(){
    const prev=state.history.pop();
    if(!prev) return;

    state.nodeId=prev.nodeId;
    state.step=prev.step;
    state.scores=prev.scores;

    const url=new URL(location.href);
    url.searchParams.delete("result");
    history.replaceState(null,"",url.toString());

    setProgress();
    render();
  }

  function restart(){
    state.started=false;
    state.nodeId="q0";
    state.step=0;
    state.history=[];
    state.scores=initScores();

    const url=new URL(location.href);
    url.searchParams.delete("result");
    history.replaceState(null,"",url.toString());

    setProgress();
    render();
  }

  function shareResult(code){
    const url=new URL(location.href);
    url.searchParams.set("result", code);
    const text=url.toString();
    navigator.clipboard?.writeText(text).then(()=>alert("已複製結果連結！"))
      .catch(()=>prompt("請手動複製：", text));
  }

  function copyResultText(code){
    const r=RESULTS[code];
    const text=`【TKU 午夜任務測驗結果】\n${r.title}\n\n${r.body}`;
    navigator.clipboard?.writeText(text).then(()=>alert("已複製結果文字！"))
      .catch(()=>prompt("請手動複製：", text));
  }

  document.getElementById("startBtn").onclick = start;
  document.getElementById("backBtn").onclick = back;
  document.getElementById("restartBtn").onclick = restart;

  (function boot(){
    const url = new URL(location.href);
    const r = url.searchParams.get("result");
    if(r && RESULTS[r]){
      // 直接顯示結果頁（分享連結用）
      state.started=true;
      state.nodeId="end";
      state.step=STEPS;
      state.history=[];
      state.scores=initScores();
      state.scores[r]=999;
      setProgress();
      render();
      return;
    }
    setProgress();
    render();
  })();
</script>
</body>
</html>
